name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          release-type: rust

  build:
    name: Build for Apple Silicon
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Build release binary
        run: cargo build --release --target aarch64-apple-darwin

      - name: Create tarball
        run: |
          cd target/aarch64-apple-darwin/release
          tar -czvf dev-cli-aarch64-apple-darwin.tar.gz dev
          shasum -a 256 dev-cli-aarch64-apple-darwin.tar.gz > dev-cli-aarch64-apple-darwin.tar.gz.sha256

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: |
            target/aarch64-apple-darwin/release/dev-cli-aarch64-apple-darwin.tar.gz
            target/aarch64-apple-darwin/release/dev-cli-aarch64-apple-darwin.tar.gz.sha256

  update-tap:
    name: Update Homebrew Tap
    needs: [release-please, build]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    steps:
      - name: Wait for release assets to be available
        run: sleep 10

      - name: Download and get SHA256
        id: sha
        env:
          TAG_NAME: ${{ needs.release-please.outputs.tag_name }}
        run: |
          curl -L -o dev-cli.tar.gz "https://github.com/AlpineJosh/dev-cli/releases/download/${TAG_NAME}/dev-cli-aarch64-apple-darwin.tar.gz"
          SHA256=$(shasum -a 256 dev-cli.tar.gz | awk '{print $1}')
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT
          echo "version=${TAG_NAME#v}" >> $GITHUB_OUTPUT

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: AlpineJosh/homebrew-tap
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        env:
          VERSION: ${{ steps.sha.outputs.version }}
          SHA256: ${{ steps.sha.outputs.sha256 }}
        run: |
          cd homebrew-tap
          cat > Formula/dev.rb << FORMULA
          class Dev < Formula
            desc "Git worktree and project management CLI"
            homepage "https://github.com/AlpineJosh/dev-cli"
            version "${VERSION}"
            license "MIT"

            on_macos do
              on_arm do
                url "https://github.com/AlpineJosh/dev-cli/releases/download/v${VERSION}/dev-cli-aarch64-apple-darwin.tar.gz"
                sha256 "${SHA256}"
              end
            end

            def install
              bin.install "dev"
            end

            test do
              system "\#{bin}/dev", "--version"
            end
          end
          FORMULA
          # Remove leading whitespace from each line
          sed -i 's/^          //' Formula/dev.rb

      - name: Commit and push
        env:
          TAG_NAME: ${{ needs.release-please.outputs.tag_name }}
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/dev.rb
          git commit -m "Update dev to ${TAG_NAME}"
          git push
